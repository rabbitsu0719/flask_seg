<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ìŒì‹ ì´ë¯¸ì§€ ë°°ê²½ì œê±° (SAM)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <header>
    <h1>ğŸœ ìŒì‹ ì´ë¯¸ì§€ ë°°ê²½ì œê±° (SAM)</h1>
    <p class="hint">ì—…ë¡œë“œ â†’ ì´ë¯¸ì§€ í´ë¦­(ì—¬ëŸ¬ ë²ˆ) â†’ ë°°ê²½ ì œê±° â†’ ë‹¤ìš´ë¡œë“œ</p>
  </header>

  <main class="grid">
    <section class="card">
      <h3>1) ì—…ë¡œë“œ</h3>
      <input id="file" type="file" accept="image/*" />
      <div class="row">
        <button id="btnUpload">ì—…ë¡œë“œ</button>
        <span id="msg" class="hint"></span>
      </div>

      <h3 style="margin-top:16px">2) ë¯¸ë¦¬ë³´ê¸° (ì—¬ê¸° í´ë¦­í•´ì„œ ì „ê²½ ì„ íƒ)</h3>
      <img id="img" alt="ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°" />
      <div class="hint">ì´ë¯¸ì§€ ìœ„ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ì§€ì ì„ ì „ê²½ìœ¼ë¡œ ê°„ì£¼í•´ ë§ˆìŠ¤í¬ê°€ ì¶”ê°€ë©ë‹ˆë‹¤.</div>

      <div class="row" style="margin-top:10px">
        <button id="btnDelete" disabled>ë°°ê²½ ì œê±° ì ìš©</button>
        <button id="btnClear" disabled>ì„ íƒ ë§ˆìŠ¤í¬ ì´ˆê¸°í™”</button>
      </div>
    </section>

    <section class="card">
      <h3>ê²°ê³¼ / í”„ë¦¬ë·°</h3>
      <img id="preview" alt="í”„ë¦¬ë·°" />
      <div class="row" style="margin-top:10px">
        <a id="btnDownload" href="#" download="edited_image.png"><button disabled>ë‹¤ìš´ë¡œë“œ(PNG)</button></a>
        <button id="btnSave" disabled>ì„œë²„ ì €ì¥</button>
      </div>

      <h3 style="margin-top:16px">ë¡œê·¸</h3>
      <pre id="log" class="log"></pre>
    </section>
  </main>

<script>
const $ = (id) => document.getElementById(id);
const imgEl = $("img");
const previewEl = $("preview");
const logEl = $("log");
const btnUpload = $("btnUpload");
const btnDelete = $("btnDelete");
const btnClear = $("btnClear");
const btnDownloadLink = $("btnDownload");
const btnDownload = btnDownloadLink.querySelector("button");
const btnSave = $("btnSave");
const msg = $("msg");

let naturalW = 0, naturalH = 0;

function log(t){ logEl.textContent = (new Date()).toLocaleTimeString() + "  " + t + "\n" + logEl.textContent; }
function enableActions(on){
  btnDelete.disabled = !on;
  btnClear.disabled  = !on;
  btnSave.disabled   = !on;
  btnDownload.disabled = !on;
}

btnUpload.addEventListener("click", async () => {
  const f = $("file").files[0];
  if(!f){ alert("ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
  const fd = new FormData();
  fd.append("image", f);
  msg.textContent = "ì—…ë¡œë“œ ì¤‘...";
  try{
    const r = await fetch("/upload", { method: "POST", body: fd });
    const j = await r.json();
    if(!r.ok){ throw new Error(j.error || "ì—…ë¡œë“œ ì‹¤íŒ¨"); }
    msg.textContent = "ì—…ë¡œë“œ ì™„ë£Œ! ì´ë¯¸ì§€ë¥¼ í´ë¦­í•´ ì „ê²½ì„ ì„ íƒí•˜ì„¸ìš”.";
    log("upload ok");
    // ë¯¸ë¦¬ë³´ê¸° ì„¤ì •
    const url = URL.createObjectURL(f);
    const img = $("img");
    img.src = url;
    img.onload = () => { naturalW = img.naturalWidth; naturalH = img.naturalHeight; };
    // ì„œë²„ ìª½ í˜„ì¬ ì´ë¯¸ì§€ í”„ë¦¬ë·°
    refreshPreview();
    enableActions(true);
  }catch(e){
    msg.textContent = e.message;
    log("upload error: " + e.message);
  }
});

$("img").addEventListener("click", async (ev) => {
  if(!naturalW || !naturalH){ alert("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”."); return; }
  const rect = ev.target.getBoundingClientRect();
  const scaleX = naturalW / rect.width;
  const scaleY = naturalH / rect.height;
  const x = Math.round((ev.clientX - rect.left) * scaleX);
  const y = Math.round((ev.clientY - rect.top)  * scaleY);

  try{
    const r = await fetch("/click", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({x, y})
    });
    if(r.ok){
      const blob = await r.blob();
      $("preview").src = URL.createObjectURL(blob);
      log(`click (${x},${y}) -> mask added`);
    }else{
      const j = await r.json().catch(()=>({}));
      throw new Error(j.error || "ë§ˆìŠ¤í¬ ìƒì„± ì‹¤íŒ¨");
    }
  }catch(e){
    log("click error: " + e.message);
    alert(e.message);
  }
});

btnDelete.addEventListener("click", async () => {
  try{
    const r = await fetch("/delete", { method:"POST" });
    const j = await r.json();
    if(!r.ok){ throw new Error(j.error || "ë°°ê²½ ì œê±° ì‹¤íŒ¨"); }
    log("delete ok");
    const pr = await fetch("/preview");
    if(pr.ok){
      const blob = await pr.blob();
      $("preview").src = URL.createObjectURL(blob);
    }
  }catch(e){
    log("delete error: " + e.message);
    alert(e.message);
  }
});

btnSave.addEventListener("click", async () => {
  try{
    const r = await fetch("/save");
    const j = await r.json();
    if(!r.ok){ throw new Error(j.error || "ì €ì¥ ì‹¤íŒ¨"); }
    log("save ok: " + (j.message || ""));
  }catch(e){
    log("save error: " + e.message);
    alert(e.message);
  }
});

btnClear.addEventListener("click", async () => {
  // ì„œë²„ì— ë³„ë„ clear ë¼ìš°íŠ¸ê°€ ì—†ë‹¤ë©´ í”„ë¦¬ë·°ë§Œ ì´ˆê¸°í™”
  $("preview").src = "";
  log("local preview cleared (ì„œë²„ ë§ˆìŠ¤í¬ëŠ” /upload ì‹œ ì´ˆê¸°í™”ë¨)");
});

btnDownloadLink.addEventListener("click", async (ev) => {
  ev.preventDefault();
  try{
    const r = await fetch("/download");
    if(!r.ok){ throw new Error("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"); }
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    btnDownloadLink.href = url;
    btnDownloadLink.click();
    log("download ok");
  }catch(e){
    log("download error: " + e.message);
    alert(e.message);
  }
});

async function refreshPreview(){
  const r = await fetch("/preview");
  if(r.ok){
    const blob = await r.blob();
    $("preview").src = URL.createObjectURL(blob);
  }else{
    $("preview").removeAttribute("src");
  }
}
</script>
</body>
</html>
